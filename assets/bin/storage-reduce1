#!/bin/bash
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
#

#
# Copyright 2019 Joyent, Inc.
#

set -o pipefail

dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
NODE=$dir/../build/node/bin/node

#
# Every task in this phase produces a summary of accounts' usage. To
# consider snaplinks, each task stores processed objects in a sqlite
# database table to be queried later on as we process new objects.
# This way, we guarantee that each stored object is accounted for
# once, regardless of the number of snaplinks pointing to that object.
#

$ZCAT \
| $NODE $dir/../lib/storage-reduce1.js \
| msplit -j -n $NUM_REDUCERS -f owner,namespace
